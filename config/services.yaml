# This file is the entry point to configure your own services.
# Files in the packages/ subdirectory configure your dependencies.

# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices.html#use-parameters-for-application-configuration
parameters:
    container.dumper.inline_class_loader: false
    locale: 'fr'

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.

    # makes classes in src/ available to be used as services
    Jblairy\PhpBenchmark\:
        resource: '../src/'
        exclude:
            - '../src/Builder/'
            - '../src/Domain/'
            - '../src/Kernel.php'

    # Clean Architecture - Port implementations

    # Code Extraction (Port -> Adapter)
    # Uses DatabaseCodeExtractor to support YAML fixtures from database
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\CodeExtractorPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Execution\CodeExtraction\DatabaseCodeExtractor

    # Benchmark Repository (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\BenchmarkRepositoryPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Persistence\Doctrine\Repository\DoctrineBenchmarkRepository

    # Script Execution (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\ScriptExecutorPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Execution\Docker\DockerScriptExecutor

    # Result Persistence (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\ResultPersisterPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Persistence\Doctrine\DoctrinePulseResultPersister
    
    # Pulse Repository (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Dashboard\Port\PulseRepositoryPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Persistence\Doctrine\Repository\PulseRepository

    # Benchmark Execution (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\BenchmarkExecutorPort:
        class: Jblairy\PhpBenchmark\Domain\Benchmark\Service\SingleBenchmarkExecutor

    # Script Builder (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\ScriptBuilderPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Execution\ScriptBuilding\InstrumentedScriptBuilder

    # Event Dispatcher (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\EventDispatcherPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Async\SymfonyEventDispatcherAdapter

    # Async Executor (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\AsyncExecutorPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Async\SpatieAsyncExecutorAdapter
        arguments:
            $concurrency: '%env(int:BENCHMARK_CONCURRENCY)%'

    # Benchmark auto-tagging (moved from Domain to keep it framework-agnostic)
    _instanceof:
        Jblairy\PhpBenchmark\Domain\Benchmark\Contract\Benchmark:
            tags: ['app.benchmark']

    # Domain Services (need explicit registration since Domain is excluded)
    Jblairy\PhpBenchmark\Domain\Dashboard\Service\StatisticsCalculator: ~

    # Fixtures configuration
    Jblairy\PhpBenchmark\Infrastructure\Persistence\Doctrine\Fixtures\YamlBenchmarkFixtures:
        arguments:
            $projectDir: '%kernel.project_dir%'
