# This file is the entry point to configure your own services.
# Files in the packages/ subdirectory configure your dependencies.

# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices.html#use-parameters-for-application-configuration
parameters:
    container.dumper.inline_class_loader: false
    locale: 'fr'
    # Benchmark execution parameters
    benchmark.warmup_iterations: '%env(int:BENCHMARK_WARMUP_ITERATIONS)%'
    benchmark.inner_iterations: '%env(int:BENCHMARK_INNER_ITERATIONS)%'
    benchmark.samples: '%env(int:BENCHMARK_SAMPLES)%'

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.

    # makes classes in src/ available to be used as services
    Jblairy\PhpBenchmark\:
        resource: '../src/'
        exclude:
            - '../src/Builder/'
            - '../src/Domain/'
            - '../src/Kernel.php'

    # Clean Architecture - Port implementations

    # Code Extraction (Port -> Adapter)
    # Uses DatabaseCodeExtractor to support YAML fixtures from database
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\CodeExtractorPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Execution\CodeExtraction\DatabaseCodeExtractor

    # Benchmark Repository (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\BenchmarkRepositoryPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Persistence\Doctrine\Repository\DoctrineBenchmarkRepository

    # Script Execution (Port -> Adapter)
    # Using DockerPoolExecutor for better performance with connection pooling
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\ScriptExecutorPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Execution\Docker\DockerPoolExecutor

    # Result Persistence (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\ResultPersisterPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Persistence\Doctrine\DoctrinePulseResultPersister

    # Pulse Repository (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Dashboard\Port\PulseRepositoryPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Persistence\Doctrine\Repository\PulseRepository

    # Benchmark Execution (Port -> Adapter)
    # Phase 3: Multi-sample execution wraps ConfigurableSingleBenchmarkExecutor
    # Executes each benchmark N times and aggregates results for CV% < 2%
    Jblairy\PhpBenchmark\Domain\Benchmark\Service\ConfigurableSingleBenchmarkExecutor: ~
    
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\BenchmarkExecutorPort:
        class: Jblairy\PhpBenchmark\Domain\Benchmark\Service\MultiSampleBenchmarkExecutor
        arguments:
            $benchmarkExecutorPort: '@Jblairy\PhpBenchmark\Domain\Benchmark\Service\ConfigurableSingleBenchmarkExecutor'
            $numberOfSamples: '%benchmark.samples%'

    # Script Builder (Port -> Adapter)
    # Uses #[Autowire] attributes for environment variable injection
    # See: https://symfony.com/doc/7.3/service_container/autowiring
    # ConfigurableScriptBuilder supports per-benchmark iteration configuration
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\ScriptBuilderPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Execution\ScriptBuilding\ConfigurableScriptBuilder

    # Event Dispatcher (Port -> Adapter)
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\EventDispatcherPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Async\SymfonyEventDispatcherAdapter

    # Logger (Port -> Adapter)
    # Bridges Domain LoggerPort to PSR-3 LoggerInterface
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\LoggerPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Logging\PsrLoggerAdapter

    # Message Bus (Port -> Adapter)
    # Bridges Domain MessageBusPort to Symfony Messenger
    Jblairy\PhpBenchmark\Domain\Benchmark\Port\MessageBusPort:
        class: Jblairy\PhpBenchmark\Infrastructure\Async\SymfonyMessageBusAdapter

    # Benchmark auto-tagging (moved from Domain to keep it framework-agnostic)
    _instanceof:
        Jblairy\PhpBenchmark\Domain\Benchmark\Contract\Benchmark:
            tags: ['app.benchmark']

    # Domain Services (need explicit registration since Domain is excluded)
    # Enhanced Statistics Calculator with outlier detection
    Jblairy\PhpBenchmark\Domain\Dashboard\Service\OutlierDetector: ~
    
    Jblairy\PhpBenchmark\Domain\Dashboard\Service\EnhancedStatisticsCalculator:
        arguments:
            $outlierDetector: '@Jblairy\PhpBenchmark\Domain\Dashboard\Service\OutlierDetector'
            $removeOutliers: true
    
    # Legacy calculator kept for backward compatibility
    Jblairy\PhpBenchmark\Domain\Dashboard\Service\StatisticsCalculator: ~

    # Fixtures configuration
    Jblairy\PhpBenchmark\Infrastructure\Persistence\Doctrine\Fixtures\YamlBenchmarkFixtures:
        arguments:
            $projectDir: '%kernel.project_dir%'
    
    # Calibration command
    Jblairy\PhpBenchmark\Infrastructure\Cli\Command\CalibrateIterationsCommand:
        arguments:
            $projectDir: '%kernel.project_dir%'
        tags: ['console.command']

    # Message Handlers
    # Configure handlers via services.yaml instead of attributes to keep Application layer
    # independent of Symfony Messenger infrastructure
    Jblairy\PhpBenchmark\Application\MessageHandler\ExecuteBenchmarkHandler:
        tags:
            - { name: 'messenger.message_handler' }
