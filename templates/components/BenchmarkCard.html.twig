<div {{ attributes.defaults({
        class: 'stats-card__container benchmark-card',
        'data-controller': 'benchmark-card-live toggle',
        'data-benchmark-card-live-benchmark-id-value': this.benchmarkId,
        'data-benchmark-card-live-benchmark-name-value': this.benchmarkName,
        'data-description': this.description,
        'data-tags': this.tags|join(',')
    }) }}>

    {% if this.data %}
        {# Loading indicator overlay - non-intrusive #}
        <div class="benchmark-card__loading-overlay" data-loading="show">
            <div class="benchmark-card__loading-spinner"></div>
        </div>

        <div>
            <div>
                <div class="benchmark-card__header">
                    <div class="benchmark-card__header-top">
                        <div class="benchmark-card__category-badge">{{ this.category }}</div>
                        <button type="button" 
                                class="benchmark-card__toggle-button"
                                data-action="click->toggle#toggle"
                                data-toggle-target="button"
                                title="Afficher le graphique">
                            <span data-toggle-target="iconChart">üìä</span>
                            <span data-toggle-target="iconTable" style="display: none;">üìã</span>
                        </button>
                    </div>
                    <h2 class="benchmark-card__title">
                        {% if this.icon %}{{ this.icon }} {% endif %}{{ this.shortName }}
                    </h2>
                </div>

                {% if this.description %}
                <div class="benchmark-card__description">
                    {{ this.description }}
                </div>
                {% endif %}

                {% if this.tags|length > 0 %}
                <div class="benchmark-card__tags">
                    {% for tag in this.tags %}
                        <span class="benchmark-card__tag">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                {% if this.sourceCode %}
                <div class="benchmark-card__code-section">
                    <div class="benchmark-card__code-header">
                        <span class="benchmark-card__code-label">Code test√©</span>
                        <span class="benchmark-card__code-lang">PHP</span>
                    </div>
                    <pre class="benchmark-card__code"><code>{{ this.sourceCode }}</code></pre>
                </div>
                {% endif %}

                <div class="benchmark-card__chart-container chart__container"
                     data-toggle-target="chart">
                    {{ render_chart(this.chart) }}
                </div>

                <div class="benchmark-card__table-wrapper" data-toggle-target="table">
                    <table class="benchmark-card__table">
                    <thead class="benchmark-card__table-header">
                    <tr>
                        <th class="benchmark-card__table-cell benchmark-card__table-cell--metric">M√©trique</th>
                        {% for phpVersion in this.data.phpVersions|keys %}
                            <th class="benchmark-card__table-cell">
                                PHP {{ phpVersion|replace({'php': ''}) }}
                            </th>
                        {% endfor %}
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="count">
                            <span class="metric-label">{{ 'metrics.count.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.count.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell">{{ stats.count }}</td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="p50">
                            <span class="metric-label">{{ 'metrics.p50.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.p50.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% set best_p50 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.getP50() < best_p50 %}
                                {% set best_p50 = stats.getP50() %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.getP50() == best_p50 %}benchmark-card__table-cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.getP50() }}">
                                {{ stats.getP50()|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>

                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="p90">
                            <span class="metric-label">{{ 'metrics.p90.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.p90.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% set best_p90 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.getP90() < best_p90 %}
                                {% set best_p90 = stats.getP90() %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.getP90() == best_p90 %}benchmark-card__table-cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.getP90() }}">
                                {{ stats.getP90()|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="p95">
                            <span class="metric-label">{{ 'metrics.p95.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.p95.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% set best_p95 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.getP95() < best_p95 %}
                                {% set best_p95 = stats.getP95() %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.getP95() == best_p95 %}benchmark-card__table-cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.getP95() }}">
                                {{ stats.getP95()|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="p99">
                            <span class="metric-label">{{ 'metrics.p99.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.p99.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% set best_p99 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.getP99() < best_p99 %}
                                {% set best_p99 = stats.getP99() %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.getP99() == best_p99 %}benchmark-card__table-cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.getP99() }}">
                                {{ stats.getP99()|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="minmax">
                            <span class="metric-label">{{ 'metrics.minmax.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.minmax.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% set best_min = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.min < best_min %}
                                {% set best_min = stats.min %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.min == best_min %}benchmark-card__table-cell--best-value{% endif %}">
                                <span data-unit-switch-target="cell" data-value="{{ stats.min }}">{{ stats.min|number_format(5) }}</span> / <span data-unit-switch-target="cell" data-value="{{ stats.max }}">{{ stats.max|number_format(5) }}</span>
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="stdDev">
                            <span class="metric-label">{{ 'metrics.std_dev.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.std_dev.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% set best_stdDev = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.stdDev < best_stdDev %}
                                {% set best_stdDev = stats.stdDev %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.stdDev == best_stdDev %}benchmark-card__table-cell--best-value{% endif %}">
                                <span data-unit-switch-target="cell" data-value="{{ stats.stdDev }}">{{ stats.stdDev|number_format(5) }}</span>
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="cv">
                            <span class="metric-label">{{ 'metrics.cv.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.cv.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% set best_cv = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.cv < best_cv %}
                                {% set best_cv = stats.cv %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            {% set stability_class = '' %}
                            {% if stats.cv < 5 %}
                                {% set stability_class = 'benchmark-card__table-cell--stability-good' %}
                            {% elseif stats.cv < 15 %}
                                {% set stability_class = 'benchmark-card__table-cell--stability-medium' %}
                            {% else %}
                                {% set stability_class = 'benchmark-card__table-cell--stability-poor' %}
                            {% endif %}
                            <td class="benchmark-card__table-cell {{ stability_class }} {% if stats.cv == best_cv %}benchmark-card__table-cell--best-value{% endif %}">
                                {{ stats.cv|number_format(2) }}%
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="avg">
                            <span class="metric-label">{{ 'metrics.avg.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.avg.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% set best_avg = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.avg < best_avg %}
                                {% set best_avg = stats.avg %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.avg == best_avg %}benchmark-card__table-cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.avg }}">
                                {{ stats.avg|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="throughput">
                            <span class="metric-label">{{ 'metrics.throughput.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.throughput.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% set best_throughput = 0 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.throughput > best_throughput %}
                                {% set best_throughput = stats.throughput %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.throughput == best_throughput %}benchmark-card__table-cell--best-value{% endif %}">
                                {{ stats.throughput|number_format(0, '.', ',') }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="memoryUsed">
                            <span class="metric-label">{{ 'metrics.memory_used.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.memory_used.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% set best_memory = 999999999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.memoryUsed < best_memory %}
                                {% set best_memory = stats.memoryUsed %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.memoryUsed == best_memory %}benchmark-card__table-cell--best-value{% endif %}">
                                {{ (stats.memoryUsed / 1024 / 1024)|number_format(2) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="memoryPeak">
                            <span class="metric-label">{{ 'metrics.memory_peak.label'|trans }}</span>
                            <button type="button" 
                                    class="metric-tooltip" 
                                    data-controller="tooltip"
                                    data-tooltip-text-value="{{ 'metrics.memory_peak.description'|trans }}"
                                    data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                                    aria-label="Plus d'informations">‚ÑπÔ∏è</button>
                        </td>
                        {% set best_memory_peak = 999999999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.memoryPeak < best_memory_peak %}
                                {% set best_memory_peak = stats.memoryPeak %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.memoryPeak == best_memory_peak %}benchmark-card__table-cell--best-value{% endif %}">
                                {{ (stats.memoryPeak / 1024 / 1024)|number_format(2) }}
                            </td>
                        {% endfor %}
                    </tr>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        {# Initial loading state - only shown on first load #}
        <div class="benchmark-card__initial-loading">
            <div class="benchmark-card__header">
                <h2 class="benchmark-card__title">{{ this.benchmarkName }}</h2>
                <div>
                    <span class="spinner">‚è≥</span> Chargement des statistiques...
                </div>
            </div>
        </div>
    {% endif %}
</div>
