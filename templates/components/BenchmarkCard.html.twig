<div {{ attributes.defaults({
        class: 'stats-card__container',
        'data-controller': 'benchmark-card-live',
        'data-benchmark-card-live-benchmark-id-value': this.benchmarkId,
        'data-benchmark-card-live-benchmark-name-value': this.benchmarkName
    }) }}>

    {% if this.data %}
        {# Loading indicator overlay - non-intrusive #}
        <div class="loading-overlay" data-loading="show">
            <div class="loading-spinner"></div>
        </div>

        <div>
            <div data-controller="toggle unit-switch">
                <div class="stats-card__flex">
                    <h2 class="stats-card__title">{{ this.data.benchmarkName }} ({{ this.data.benchmarkId }})</h2>
                    <div>
                        <button class="button__toggle" data-action="toggle#toggle">
                            Afficher/Masquer le graphique
                        </button>
                        <button class="button__toggle" data-action="unit-switch#toggle">
                            ms/ns
                        </button>
                    </div>
                </div>

                <div class="chart__container" data-toggle-target="chart">
                    {{ render_chart(this.chart) }}
                </div>

                <div class="table-wrapper">
                    <table class="table">
                    <thead class="table__header">
                    <tr>
                        <th class="table__cell">Métrique</th>
                        {% for phpVersion in this.data.phpVersions|keys %}
                            <th class="table__cell table__cell--metric">
                                PHP {{ phpVersion|replace({'php': ''}) }}
                            </th>
                        {% endfor %}
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="table__row">
                        <td class="table__cell table__cell--metric" data-metric="count">Échantillons</td>
                        {% for stats in this.data.phpVersions %}
                            <td class="table__cell">{{ stats.count }}</td>
                        {% endfor %}
                    </tr>
                    <tr class="table__row">
                        <td class="table__cell table__cell--metric" data-metric="p50">p50 (ms)</td>
                        {% set best_p50 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.p50 < best_p50 %}
                                {% set best_p50 = stats.p50 %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="table__cell {% if stats.p50 == best_p50 %}table__cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.p50 }}">
                                {{ stats.p50|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="table__row">
                        <td class="table__cell table__cell--metric" data-metric="p80">p80 (ms)</td>
                        {% set best_p80 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.p80 < best_p80 %}
                                {% set best_p80 = stats.p80 %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="table__cell {% if stats.p80 == best_p80 %}table__cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.p80 }}">
                                {{ stats.p80|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="table__row">
                        <td class="table__cell table__cell--metric" data-metric="p90">p90 (ms)</td>
                        {% set best_p90 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.p90 < best_p90 %}
                                {% set best_p90 = stats.p90 %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="table__cell {% if stats.p90 == best_p90 %}table__cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.p90 }}">
                                {{ stats.p90|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="table__row">
                        <td class="table__cell table__cell--metric" data-metric="p95">p95 (ms)</td>
                        {% set best_p95 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.p95 < best_p95 %}
                                {% set best_p95 = stats.p95 %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="table__cell {% if stats.p95 == best_p95 %}table__cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.p95 }}">
                                {{ stats.p95|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="table__row">
                        <td class="table__cell table__cell--metric" data-metric="p99">p99 (ms)</td>
                        {% set best_p99 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.p99 < best_p99 %}
                                {% set best_p99 = stats.p99 %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="table__cell {% if stats.p99 == best_p99 %}table__cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.p99 }}">
                                {{ stats.p99|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="table__row">
                        <td class="table__cell table__cell--metric" data-metric="avg">Moyenne (ms)</td>
                        {% set best_avg = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.avg < best_avg %}
                                {% set best_avg = stats.avg %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="table__cell {% if stats.avg == best_avg %}table__cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.avg }}">
                                {{ stats.avg|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="table__row">
                        <td class="table__cell table__cell--metric" data-metric="memoryUsed">Mémoire utilisée (Mo)</td>
                        {% set best_memory = 999999999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.memoryUsed < best_memory %}
                                {% set best_memory = stats.memoryUsed %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="table__cell {% if stats.memoryUsed == best_memory %}table__cell--best-value{% endif %}">
                                {{ (stats.memoryUsed / 1024 / 1024)|number_format(2) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="table__row">
                        <td class="table__cell table__cell--metric" data-metric="memoryPeak">Pic de mémoire (Mo)</td>
                        {% set best_memory_peak = 999999999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.memoryPeak < best_memory_peak %}
                                {% set best_memory_peak = stats.memoryPeak %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="table__cell {% if stats.memoryPeak == best_memory_peak %}table__cell--best-value{% endif %}">
                                {{ (stats.memoryPeak / 1024 / 1024)|number_format(2) }}
                            </td>
                        {% endfor %}
                    </tr>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        {# Initial loading state - only shown on first load #}
        <div class="initial-loading">
            <div class="stats-card__flex">
                <h2 class="stats-card__title">{{ this.benchmarkName }}</h2>
                <div>
                    <span class="spinner">⏳</span> Chargement des statistiques...
                </div>
            </div>
        </div>
    {% endif %}

    <style>
    /* Modern card styling with smooth transitions */
    .stats-card__container {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: visible;
    }

    /* Loading overlay - non-intrusive indicator */
    .loading-overlay {
        position: absolute;
        top: 0;
        right: 0;
        padding: 0.5rem;
        pointer-events: none;
        z-index: 10;
        display: none;
    }

    .loading-overlay[data-loading="show"] {
        display: block;
        animation: fadeIn 0.2s ease-in;
    }

    .loading-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(16, 185, 129, 0.2);
        border-top-color: #10b981;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Initial loading state */
    .initial-loading {
        padding: 2rem;
        text-align: center;
        animation: fadeIn 0.3s ease-in;
    }

    /* Table wrapper with horizontal scroll */
    .table-wrapper {
        overflow-x: auto;
        overflow-y: visible;
        margin: 1rem 0;
        border-radius: 8px;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        /* Custom scrollbar styling */
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
    }

    .table-wrapper::-webkit-scrollbar {
        height: 8px;
    }

    .table-wrapper::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }

    .table-wrapper::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .table-wrapper::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Scroll hint gradient */
    .table-wrapper::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 8px;
        width: 40px;
        background: linear-gradient(to left, white, transparent);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .table-wrapper:not(:hover)::after {
        opacity: 1;
    }

    /* Smooth reload animation */
    @keyframes cardReload {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
        100% {
            opacity: 1;
        }
    }

    .stats-card__container[data-loading] {
        animation: cardReload 0.6s ease-in-out;
    }

    /* Fixed-width table cells to prevent layout shifts */
    .table__cell {
        min-width: 100px;
        width: 100px;
        text-align: right;
        font-variant-numeric: tabular-nums;
        transition: background-color 0.3s ease, color 0.3s ease;
        padding: 0.75rem 1rem;
        white-space: nowrap;
    }

    .table__cell--metric {
        text-align: left;
        min-width: 200px;
        width: 200px;
        font-weight: 500;
        position: sticky;
        left: 0;
        background: white;
        z-index: 2;
        box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
    }

    /* Remove shadow on first column when not scrolled */
    .table-wrapper:not(.scrolled) .table__cell--metric {
        box-shadow: none;
    }

    /* Monospace numbers for consistent width */
    .table__cell:not(.table__cell--metric) {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace;
        font-size: 0.95em;
        letter-spacing: 0.02em;
    }

    /* Real-time update animations */
    .cell-updating {
        animation: cellPulse 1s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    @keyframes cellPulse {
        0% {
            background-color: #10b981;
            color: white;
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        50% {
            background-color: #34d399;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
        }
        100% {
            background-color: transparent;
            color: inherit;
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
    }

    /* Best value styling */
    .table__cell--best-value {
        background-color: rgba(16, 185, 129, 0.1);
        font-weight: 600;
        position: relative;
    }

    .table__cell--best-value::before {
        content: '★';
        position: absolute;
        left: 8px;
        color: #10b981;
        font-size: 0.8em;
    }

    /* Table styling improvements */
    .table {
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 8px;
        overflow: hidden;
        width: max-content;
        min-width: 100%;
        background: white;
    }

    .table__row {
        transition: background-color 0.2s ease;
    }

    .table__row:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    /* Card header improvements */
    .stats-card__title {
        font-size: 1.1em;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Smooth transitions for all interactive elements */
    .button__toggle {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .button__toggle:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .button__toggle:active {
        transform: translateY(0);
    }

    /* Loading state styling */
    [data-loading="show"] {
        animation: fadeIn 0.3s ease-in;
    }

    [data-loading="hide"] {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-4px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Chart container improvements */
    .chart__container {
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                    opacity 0.3s ease,
                    margin 0.3s ease;
        overflow: hidden;
    }

    .chart__container:not([style*="display: none"]) {
        animation: expandIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes expandIn {
        from {
            max-height: 0;
            opacity: 0;
        }
        to {
            max-height: 500px;
            opacity: 1;
        }
    }
    </style>
</div>
