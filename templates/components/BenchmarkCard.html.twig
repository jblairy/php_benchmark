<div {{ attributes.defaults({
        class: 'stats-card__container benchmark-card',
        'data-controller': 'benchmark-card-live',
        'data-benchmark-card-live-benchmark-id-value': this.benchmarkId,
        'data-benchmark-card-live-benchmark-name-value': this.benchmarkName
    }) }}>

    {% if this.data %}
        {# Loading indicator overlay - non-intrusive #}
        <div class="benchmark-card__loading-overlay" data-loading="show">
            <div class="benchmark-card__loading-spinner"></div>
        </div>

        <div>
            <div data-controller="toggle unit-switch">
                <div class="benchmark-card__header">
                    <div class="benchmark-card__title-group">
                        <div class="benchmark-card__category">{{ this.category }}</div>
                        <h2 class="benchmark-card__title">{{ this.shortName }}</h2>
                    </div>
                    <div class="benchmark-card__actions">
                        <button class="button__toggle" data-action="toggle#toggle">
                            Afficher/Masquer le graphique
                        </button>
                        <button class="button__toggle" data-action="unit-switch#toggle">
                            ms/ns
                        </button>
                    </div>
                </div>

                {% if this.sourceCode %}
                <div class="benchmark-card__code-section">
                    <div class="benchmark-card__code-header">
                        <span class="benchmark-card__code-label">Code testé</span>
                        <span class="benchmark-card__code-lang">PHP</span>
                    </div>
                    <pre class="benchmark-card__code"><code>{{ this.sourceCode }}</code></pre>
                </div>
                {% endif %}

                <div class="benchmark-card__chart-container chart__container" data-toggle-target="chart">
                    {{ render_chart(this.chart) }}
                </div>

                <div class="benchmark-card__table-wrapper">
                    <table class="benchmark-card__table">
                    <thead class="benchmark-card__table-header">
                    <tr>
                        <th class="benchmark-card__table-cell benchmark-card__table-cell--metric">Métrique</th>
                        {% for phpVersion in this.data.phpVersions|keys %}
                            <th class="benchmark-card__table-cell">
                                PHP {{ phpVersion|replace({'php': ''}) }}
                            </th>
                        {% endfor %}
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="count">Échantillons</td>
                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell">{{ stats.count }}</td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="p50">p50 (ms)</td>
                        {% set best_p50 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.p50 < best_p50 %}
                                {% set best_p50 = stats.p50 %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.p50 == best_p50 %}benchmark-card__table-cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.p50 }}">
                                {{ stats.p50|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="p80">p80 (ms)</td>
                        {% set best_p80 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.p80 < best_p80 %}
                                {% set best_p80 = stats.p80 %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.p80 == best_p80 %}benchmark-card__table-cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.p80 }}">
                                {{ stats.p80|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="p90">p90 (ms)</td>
                        {% set best_p90 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.p90 < best_p90 %}
                                {% set best_p90 = stats.p90 %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.p90 == best_p90 %}benchmark-card__table-cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.p90 }}">
                                {{ stats.p90|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="p95">p95 (ms)</td>
                        {% set best_p95 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.p95 < best_p95 %}
                                {% set best_p95 = stats.p95 %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.p95 == best_p95 %}benchmark-card__table-cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.p95 }}">
                                {{ stats.p95|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="p99">p99 (ms)</td>
                        {% set best_p99 = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.p99 < best_p99 %}
                                {% set best_p99 = stats.p99 %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.p99 == best_p99 %}benchmark-card__table-cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.p99 }}">
                                {{ stats.p99|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="avg">Moyenne (ms)</td>
                        {% set best_avg = 999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.avg < best_avg %}
                                {% set best_avg = stats.avg %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.avg == best_avg %}benchmark-card__table-cell--best-value{% endif %}"
                                data-unit-switch-target="cell"
                                data-value="{{ stats.avg }}">
                                {{ stats.avg|number_format(5) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="memoryUsed">Mémoire utilisée (Mo)</td>
                        {% set best_memory = 999999999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.memoryUsed < best_memory %}
                                {% set best_memory = stats.memoryUsed %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.memoryUsed == best_memory %}benchmark-card__table-cell--best-value{% endif %}">
                                {{ (stats.memoryUsed / 1024 / 1024)|number_format(2) }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr class="benchmark-card__table-row">
                        <td class="benchmark-card__table-cell benchmark-card__table-cell--metric" data-metric="memoryPeak">Pic de mémoire (Mo)</td>
                        {% set best_memory_peak = 999999999999 %}
                        {% for stats in this.data.phpVersions %}
                            {% if stats.memoryPeak < best_memory_peak %}
                                {% set best_memory_peak = stats.memoryPeak %}
                            {% endif %}
                        {% endfor %}

                        {% for stats in this.data.phpVersions %}
                            <td class="benchmark-card__table-cell {% if stats.memoryPeak == best_memory_peak %}benchmark-card__table-cell--best-value{% endif %}">
                                {{ (stats.memoryPeak / 1024 / 1024)|number_format(2) }}
                            </td>
                        {% endfor %}
                    </tr>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        {# Initial loading state - only shown on first load #}
        <div class="benchmark-card__initial-loading">
            <div class="benchmark-card__header">
                <h2 class="benchmark-card__title">{{ this.benchmarkName }}</h2>
                <div>
                    <span class="spinner">⏳</span> Chargement des statistiques...
                </div>
            </div>
        </div>
    {% endif %}
</div>
