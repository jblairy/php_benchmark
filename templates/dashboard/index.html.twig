{% extends 'base.html.twig' %}

{% block title %}Comparaison par version PHP{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('app') }}
{% endblock %}

{% block body %}
    <div class="dashboard__container">
        <h1 class="dashboard__title">Comparaison par version PHP</h1>

        {% if stats|length > 0 %}
            <div class="stats-card__container">
                <h2 class="dashboard__subtitle">Vue d'ensemble des benchmarks</h2>
                <p>Nombre total de benchmarks: {{ stats|length }}</p>
                <p>Versions PHP comparées: {{ allPhpVersions|join(', ') }}</p>
            </div>

            {% for benchmarkKey, benchmark in stats %}
                <div class="stats-card__container" id="benchmark-{{ benchmarkKey | replace({'\\': '_'}) }}">
                    <div data-controller="toggle unit-switch">
                        <div class="stats-card__flex">
                            <h2 class="stats-card__title">{{ benchmark.name }} ({{ benchmark.benchId }})</h2>
                            <div>
                                <button class="button__toggle" data-action="toggle#toggle">
                                    Afficher/Masquer le graphique
                                </button>
                                <button class="button__toggle" data-action="unit-switch#toggle">
                                    ms/ns
                                </button>
                            </div>
                        </div>

                        <div class="chart__container"
                             data-toggle-target="chart">
                            {{ render_chart(benchmark.chart) }}
                        </div>

                        <table class="table">
                            <thead class="table__header">
                            <tr>
                                <th class="table__cell">Métrique</th>
                                {% for version in allPhpVersions %}
                                    <th class="table__cell table__cell--metric">
                                        PHP {{ version|replace({'php': ''}) }}</th>
                                {% endfor %}
                            </tr>
                            </thead>
                            <tbody>
                            <tr class="table__row">
                                <td class="table__cell table__cell--metric">Échantillons</td>
                                {% for version in allPhpVersions %}
                                    <td class="table__cell">
                                        {% if benchmark.phpVersions[version] is defined %}
                                            {{ benchmark.phpVersions[version].count }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr class="table__row">
                                <td class="table__cell table__cell--metric" data-metric="p50">p50 (ms)</td>
                                {% set best_p50 = 999999 %}
                                {% for version in allPhpVersions %}
                                    {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].p50 < best_p50 %}
                                        {% set best_p50 = benchmark.phpVersions[version].p50 %}
                                    {% endif %}
                                {% endfor %}

                                {% for version in allPhpVersions %}
                                    <td class="table__cell {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].p50 == best_p50 %}table__cell--best-value{% endif %}"*
                                        data-unit-switch-target="cell"
                                        data-value="{{ benchmark.phpVersions[version].p50|default(0) }}">
                                        {% if benchmark.phpVersions[version] is defined %}
                                            {{ benchmark.phpVersions[version].p50|number_format(5) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr class="table__row">
                                <td class="table__cell table__cell--metric" data-metric="p80">p80 (ms)</td>
                                {% set best_p80 = 999999 %}
                                {% for version in allPhpVersions %}
                                    {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].p80 < best_p80 %}
                                        {% set best_p80 = benchmark.phpVersions[version].p80 %}
                                    {% endif %}
                                {% endfor %}

                                {% for version in allPhpVersions %}
                                    <td class="table__cell {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].p80== best_p80 %}table__cell--best-value{% endif %}"*
                                        data-unit-switch-target="cell"
                                        data-value="{{ benchmark.phpVersions[version].p80|default(0) }}">
                                        {% if benchmark.phpVersions[version] is defined %}
                                            {{ benchmark.phpVersions[version].p80|number_format(5) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr class="table__row">
                                <td class="table__cell table__cell--metric" data-metric="p90">p90 (ms)</td>
                                {% set best_p90 = 999999 %}
                                {% for version in allPhpVersions %}
                                    {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].p90 < best_p90 %}
                                        {% set best_p90 = benchmark.phpVersions[version].p90 %}
                                    {% endif %}
                                {% endfor %}

                                {% for version in allPhpVersions %}
                                    <td class="table__cell {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].p90 == best_p90 %}table__cell--best-value{% endif %}"*
                                        data-unit-switch-target="cell"
                                        data-value="{{ benchmark.phpVersions[version].p90|default(0) }}">
                                        {% if benchmark.phpVersions[version] is defined %}
                                            {{ benchmark.phpVersions[version].p90|number_format(5) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr class="table__row">
                                <td class="table__cell table__cell--metric" data-metric="p95">p95 (ms)</td>
                                {% set best_p95 = 999999 %}
                                {% for version in allPhpVersions %}
                                    {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].p95 < best_p95 %}
                                        {% set best_p95 = benchmark.phpVersions[version].p95 %}
                                    {% endif %}
                                {% endfor %}

                                {% for version in allPhpVersions %}
                                    <td class="table__cell {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].p95 == best_p95 %}table__cell--best-value{% endif %}"*
                                        data-unit-switch-target="cell"
                                        data-value="{{ benchmark.phpVersions[version].p95|default(0) }}">
                                        {% if benchmark.phpVersions[version] is defined %}
                                            {{ benchmark.phpVersions[version].p95|number_format(5) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr class="table__row">
                                <td class="table__cell table__cell--metric" data-metric="p99">p99 (ms)</td>
                                {% set best_p99 = 999999 %}
                                {% for version in allPhpVersions %}
                                    {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].p99 < best_p99 %}
                                        {% set best_p99 = benchmark.phpVersions[version].p99 %}
                                    {% endif %}
                                {% endfor %}

                                {% for version in allPhpVersions %}
                                    <td class="table__cell {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].p99 == best_p99 %}table__cell--best-value{% endif %}"*
                                        data-unit-switch-target="cell"
                                        data-value="{{ benchmark.phpVersions[version].p99|default(0) }}">
                                        {% if benchmark.phpVersions[version] is defined %}
                                            {{ benchmark.phpVersions[version].p99|number_format(5) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr class="table__row">
                                <td class="table__cell table__cell--metric" data-metric="avg">Moyenne (ms)</td>
                                {% set best_avg = 999999 %}
                                {% for version in allPhpVersions %}
                                    {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].avg < best_avg %}
                                        {% set best_avg = benchmark.phpVersions[version].avg %}
                                    {% endif %}
                                {% endfor %}

                                {% for version in allPhpVersions %}
                                    <td class="table__cell {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].avg == best_avg %}table__cell--best-value{% endif %}"*
                                        data-unit-switch-target="cell"
                                        data-value="{{ benchmark.phpVersions[version].avg|default(0) }}">
                                        {% if benchmark.phpVersions[version] is defined %}
                                            {{ benchmark.phpVersions[version].avg|number_format(5) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr class="table__row">
                                <td class="table__cell table__cell--metric" data-metric="memoryUsed">Mémoire utilisée (Mo)</td>
                                {% set best_memory = 999999999999 %}
                                {% for version in allPhpVersions %}
                                    {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].memoryUsed < best_memory %}
                                        {% set best_memory = benchmark.phpVersions[version].memoryUsed %}
                                    {% endif %}
                                {% endfor %}

                                {% for version in allPhpVersions %}
                                    <td class="table__cell {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].memoryUsed == best_memory %}table__cell--best-value{% endif %}">
                                        {% if benchmark.phpVersions[version] is defined %}
                                            {{ (benchmark.phpVersions[version].memoryUsed / 1024 / 1024)|number_format(2) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr class="table__row">
                                <td class="table__cell table__cell--metric" data-metric="memoryPeak">Pic de mémoire (Mo)</td>
                                {% set best_memory_peak = 999999999999 %}
                                {% for version in allPhpVersions %}
                                    {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].memoryPeak < best_memory_peak %}
                                        {% set best_memory_peak = benchmark.phpVersions[version].memoryPeak %}
                                    {% endif %}
                                {% endfor %}

                                {% for version in allPhpVersions %}
                                    <td class="table__cell {% if benchmark.phpVersions[version] is defined and benchmark.phpVersions[version].memoryPeak == best_memory_peak %}table__cell--best-value{% endif %}">
                                        {% if benchmark.phpVersions[version] is defined %}
                                            {{ (benchmark.phpVersions[version].memoryPeak / 1024 / 1024)|number_format(2) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-message">
                <p>Aucune donnée de performance disponible.</p>
            </div>
        {% endif %}
    </div>
{% endblock %}
